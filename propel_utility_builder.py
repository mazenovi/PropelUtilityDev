import sys
import os
import re
import binascii

imported_modules = [
  'sys',
  'os',
  'grt',
  'mforms',
  're',
  'pickle',
  'new',
  'warnings',
  'tempfile',
  'binascii'
]

included_files = [
  'ElementTree',
  'PropelForm',
  'PropelObject',
  'PropelColumn',
  'PropelForeignKey',
  'PropelIndice',
  'PropelBehavior',
  'PropelTable',
  'PropelExternalSchema',
  'PropelDatabase',
  'PropelTab',
  'PropelTabGrid',
  'PropelTabDatabase',
  'PropelTabTables',
  'PropelTabColumns',
  'PropelTabForeignKeys',
  'PropelTabIndices',
  'PropelTabBehaviors',
  'PropelTabFile',
  'PropelTabExternalSchemas',
  'PropelTabExport',
  '../propel_utility_dev_grt'
]

builded_file = 'propel_utility_grt.py'

# importations
builded = 'from wb import *\n'
for module in imported_modules:
  builded += 'import '+ module +'\n'

# include
for file in included_files:
  i = open('PropelUtility/' + file + '.py', 'r')
  builded += "\n# " + file + "\n"
  for line in i:
    if not re.match("^\n", line) and not re.match("^[\t ]*#", line) and not re.match("^from", line) and not re.match("^import", line):
      builded += line
  i.close()

# pop namespace in main
builded = builded.replace('self.db = PropelDatabase.PropelDatabase(grt.root.wb.doc.physicalModels[0].catalog)','self.db = PropelDatabase(grt.root.wb.doc.physicalModels[0].catalog)')
builded = builded.replace('tTab = getattr(self.tabs[name][\'class\'], self.tabs[name][\'method\'])(False, name, self.db)', 'tTab = self.tabs[name][\'class\'](False, name, self.db)')
builded = builded.replace('ET.', '')

# remove dev labels
builded = builded.replace('Propel Utilities (Dev)', 'Propel Utilities')
builded = builded.replace('PropelUtilityDev', 'PropelUtility')
builded = builded.replace('Propel Utilty (Dev)', 'Propel Utility')
builded = builded.replace('PropelEraseDev', 'PropelErase')
builded = builded.replace('Propel Erase All Data (Dev)', 'Propel Erase All Data')

# code specific to module
builded = re.sub(re.compile('^__all__.*=.*\[\n(\s*"\w+",\n*)+\s*\]\n', re.MULTILINE), '', builded)
builded = re.sub(re.compile('^__all__.*=.*\[.*\]\s*\n', re.MULTILINE), '', builded)
builded = re.sub('VERSION = ".*"\n', '', builded)

# import propel image in python code
sys.path.append(str(os.path.dirname(os.path.realpath(__file__))) + '/PropelUtility')

img = open(str(os.path.dirname(os.path.realpath(__file__))) + '/PropelUtility/propel-logo.png', 'rb')
builded_img = ''
for line_img in img:
  builded_img += binascii.hexlify(line_img)

builded = builded.replace(
  'img.set_image(str(os.path.dirname(os.path.realpath(__file__))) + \'/PropelUtility/propel-logo.png\')',
  """
    imgfile = str(tempfile.gettempdir() + '/propel-logo.png')
    if not os.path.exists(imgfile):
        i = open(imgfile, 'wb')
        i.write(binascii.unhexlify('89504e470d0a1a0a0000000d494844520000013a0000005408020000009da96c950000000467414d410000b18f0bfc61050000000970485973000006f4000006f40173eb209a0000001974455874536f667477617265005061696e742e4e45542076332e352e39403cb0cb0000158c49444154785eed5dfb73d5c515e7ffa8af994ea7b555ebf4876aa7b5adb6b6b6d399dacef497fed0fee00b04e44d080408eff71b0221101212decf90040441b012b5151f15022a3eaa33fe54674882610447bffd246bd72ffbddb37b76bf7b6feebdd9cc1d07ef3d7bf69cb3fbd93dfb3a67444ffc8b16881628130b8c281339a398d102d1023d11aeb113440b948d05225ccba6a9a2a0656a81c953aa1e7bfcc9eca7a5a5d555a30857578b45fa6801370b68b1faf8134fb97119a48e70f5305a2c122dc0b540ed9cb95ab8aedf50c76591a28b70f5305a2c122dc0b58016abf8925bfe66ba08573fbbc552d102760bac5cb55a0bd7858b16db0beb28225cfdec164b450bd82d10766a8d6b57bbc52345b4809f05b66e6dd4c2755af50c3f8611aede768b05a3052c1678f2a9515ab8e6315c7486f3582f968d16d05b60dffe035aac8e1b3f218fc9225cf3582f968d16d05b60ccd8715ab81e3adc96c76411ae79ac17cb460be82da0c5eac851a373da2bc235a70163f16801d50253a64ed3c2b5b9b925a7b12a0aaed72ecfec3bf7db2b676ebd72e65b57dff8534ed3c4e2d1027e160878eb5011a0ece17aed724def3f1f003eb31f3f5b334b6d6f695db47849f5f49ad1639e41f33cf1e448dce49ebf606153f37626072dd9baf51bb41f03cf43870e7b5c16170cdbdb3b56ad5e337bf69cf11326e1162b147966dc8499b36a57af599b470b7ed9ad8ddb162c5c5c356dfaa8a7c7a0f6a7463e3db5aa1adfecd8b98bcfc48f5269c151a346cfa899b57af5da96d61d7e0c45a9b973e76be1ba6edd863c6c45d93286ebd537feac45e9d75fbe707b7eeb6439cc993b4f746bf367c2c4c91eb5af59bb5ecb163d40e1b666ed3a6533c3a9ba0d751bc52863fe600cc2d8e1c499437ce4483b8061ad1d0453a65671183ad1305b70d6ec5a27b69238f8d588b418e509d7ae1f9a803a38d3fad99a2ad5bcbd450cff4e9f254b973989410d0469263533676765c0acceac6846cd4c2715408c7181c9dc4a56bfb9813a8d3448e5771b5e11c6af05172e5a62552a4d80c959ab08bf81ccd595135c3f3bff37b12eb57efa5e7dc8c9ca06e2a6a666ce744af5b669d5d39992346e6bd23281732838501b18ccfbe213274d76056a9a9ea9054506c8e5a97dc18245de02e46c4127a471065c6f4550b03ce0dafbcafd56887e4310ce0da64ecf9c7a1e16879c16c2b24dcb562c2c0d3562e167e68fbeee24b096f8e9d163395a6469b0b4c601467e01fcb65583b420d34ba2065c6b03f10d5bea70ed7de95e07a0867383837471d947aded415d82e1f47203f3b623ed795c03a5f6152b5659155108a6cf70f6bd0d2a3bd55ee416846cd480eb2476d93ac3ee400db564c54d310e4ef8342b565a3abaf724808d5caa8157ae5ac3979043e91a00c163b56f16833fc1066fc1b5ebd69b8174e0e021adf08606f2807149ceae8c9d24ed947bed5dffb70ec27638d808381dc9f6b376740e5a141a80017317d5e4d853f5e0692dc2bc438733122b2b0f028e435ea016c492c48caeb1cf8cd76a74f0d0610f5852454a0cae5df7b8babe92beffd2f89c76d9b3779fb90f615773f19265ad3b76a62baaaf6f30af2d054f836c93274f65f65db85bd6611e15515d47d682e362889d1669e7aedd73e72db08a5157b7c96ae44df59bcd7c30d02c5fb172f79ebd6956385bb28a6d3623b8f9b5200e990dde0d4eb3f61f3868d55aab32dacb5ad089a064e0da75b73750fbfef5a093ce5a62f45743270350cd9e58ed9c79e63e6a90d00a124180b3568e9a63c69a0e54b347b8699e58eb9a859937df726204d41938607adcb76fbf410becca789b314f0b4e9c34455b2f8ecd3836afaaaad616c7a634a7389fa604e0da759707507b5fb9afffed497c3dcd94bb76eda17a09fc581cd9712ac2199da1ab511c701c6f85ab3ccbb18a61b8fc80185fd6e282c0200ffaa581c9860d245631cfecdf7f802380f96498e2e0dd82b856a5d517ed6e1e59d292501c38fa3ad10c295ccffec009a83d5df77cd63dd2493d2631d5415d9f5078c0d5ea7e630f83a98561bd5ab7d1eec4ca5a0cbebde1da407b4727a50bbc5ca60ad6f182e2e3d782d432c4b029901560de7cfd2282e90d39596668e0dafbd28f9840ed79f1bbb81de1a4922b312e8b6a1b7bdcf889aeac0cdb545a564b972d37c015ab26be003865a158ed35fa9fd92a806d8a55c396ad944894ee1ea78eaea39e470b5267a4d04259545b9b8092d65ad083a0d870ed7bf5410e50fbce3deca18c4711dc3ad29a9bef7fa62b9d3ebdc6a9f1426115db8f4ef55a0d4571c3755f6d596a42c692de5a579680821ff6a8b2c41e2d4885d5c70e9cabb4e435ef790b5c5971e88b07d7ab6ffec50cd49eb3777ed6ed13da9ca3a796068b93b0ab0eeaa451bbc1b37153bd61c1eca414e6612d2b65fb97c913af619cc0dfd0b0554befba9490e251b5631f4b51c1b505f15e8a6af19d5e6f800a7deb50d1b71870edbf38faca995b08acded2f7daef98dd283819750dc5fb0995532fa75ada7a48abd881ba8e8b19cfcf62b36bf581e7a9c9277897e59bd1a905a94bd71eeeba302c367e03ba669cc62a2c5cafbd577be5853b342f51bbee028639f2158e6673c316adadd1a8de95f2e7ead6d69d54a7741d2cf89d9ba917053fed1d89c58b976a05b01ef950c26096d332c4a6b75284df82d8dba79ac6d5da69198a70ebb088b3ebd93b6f06eaad7dafff81d9630c64c9473549f7c3c9b9db9273b726e7fc1fb5069f13a849497bb1815a9ee1dd8c938970df80408bffda49cb903af10f3e5850fbdb596795d98238302fc41c48ed17b86e833b35774166d7de977f2c81daf3d2bdfd97023c984cceff6c109f99cf659f7de3e0219ba9630cedee6e5bdb9150bd9ceab2cc43ce6c5fc14d06ad6c7b6ebe84240ae2a98a9678d9f2154ebd5012232c869661f6cdad930db34f82f8d78f29457019582b2ae70a949f71502a305cfbcefd6600a82fdc162a5452f2de63c96b77e8813a085d3fcd83876c765a445117d09152c5559d50b017f52e5bae9faba97bea616b8700cc091394d426bc762d03375e8a4a45a8c00a168342f6439deb38f920aecd4ad10783ebd57fff15a7a9016f1a91d3697a823dff530f43040fd94cddb6a5fc22fe12d7ac1dd687a158898a9ce0b76993fe6ef0cc59ac8b7b59d5a8ad20ed137f4a546c536b8d26986f236e0542662d43dca3d072a34e8f1a1b9b3c3a24bf4830b8f2ab3453261f8e4b5efbb6613a4dfde4b970a5ee731f6e3be2a105e510521bbcd4b5588f10278667df1e8a50331bf5a8803a3df2a81a4510cfcd69bea2e00a07c15500c30d138a95d3b8e62a8f81be84e09a5c7c8487d2ff2f5f3faef53384d6d67e8784860baed4cba9802d4db1c2f74e96d9bd9bbc324de55fa2eed3e3aebc53d582d8109846cb0d032ba53bf6f09c04a076b6c11ff790b5aca887efccb0214ee229c42501d7a4fbd76e40853f7ce9513fb5c990cdbc7bfce94a0d776ba9f7e894dbcc0c2fa2a86c802b6edb33ed6388a264e8fad48e14b3d23419c5cae0bb52f7f28541f832185eb11b1e2a061c70f9a20aca21866b72e12167a002ab171f71d553d20759ec018d06a81892ed866d69830cf80973a6d94a783c60808ad9ddd056cd793e9e160951cb0c2a1862a6521bfb821be728650b91cd5170303c3344b860adcc8887eadd27f905870caec985077d800aac5ef8255f3d85920cd97c73345dc34d576b4415bc5fa7c483b3a46de9e0216d652dd4becbc18387cc7186cd2e25e5bb2ade23820953a6303f3684fc66ef808ab42215d7de2e16c250bbdfb2aca105519cbf77eddd4b0d058700aec09b275081d5b77e92c70accc94d90e16c0640c23d55b41f27d0018a98cf1b99b5f31564c6a901f6907000d302f63339450c7d5dc8a655443961c663004186da31f3e0950f62f31b26f3344fce733fb367217fc5d62e6669b40b02b5738a98b30750b7a3f2dc84e33777b19de1e4c22ffc81dafdabe46372b4e6e84c856c5662d8222a0fa75db334e696a6bcaf3c2d6df6c9fdb4b03ef5a4ce3c10f325dd0a9c80385909319a20a205a73539e38e9305387b8dd4563c47e02034459a5d93f33ff701ea5bf727ff71bb9467300ad38d716a6341cc59b305bf986198e83c54104570946aed554c1fc14306a7370986d3178faa39d93da8ede880590eacc62f385c93f30fb801f5cd7b93f70307a48215a8e7c8ca113c7505d7d0030c1b4bd2fab8c1a7e5903faa65a840be9ced99c185df0aad2278679fee6a8677bf94253d926879c092233c8519842bd016e7c788b1a2d14a5040b826177fcf05eaebdf4b2effdd2a6b1e02e6e309a71ec03f63a4f675fc2e662876602e0829d5068251b1f38e16626aa58e76adcd6ddd70b2b6a6351c695a062d37384d563903121404aec01e0ba8dd450a1941b52b8eddd2a644c2256b030b02cc45fc104ad4de8ceb81bea1d5fd027003a84eb79429fb28e102e16e30cde8e4fd6ad5373cf137cb80bd372714e1adaf96218e949cf8e4240e0c572c35f1a8cd84d537be9fbc5fd490113010b5af8bf42d69f351b7ead2ede471e84205c554e215e76c48ebd1485a0bccf61e095499b70e3958c52e714e7dd3c5cdb15a1579b0e3e851b547de5d8f5aac4542c23579fd3b04506fcb73b1c1aa839540db81949dc08e8e4e6a2f0a8e34d666080f6fad484b8088a1ba4f414ed5710442bda48511b0a4447c7d3f2df030456b46e5812ef5b8546cc815f49a9e21d4335a10a771cc14047ef6294ea930704db03f947d89fae6ddc9076e17380ba13315b2d9b0600374c3e64a28845e1c9e787bc421e3d050cb6f43591cc904599c73c45368502fae8278142cf12279e19ad9f8bd3db914206484b0daa953adeded1bf139768c8c9769b5af764e708d8764ada5e209b466e49c6055bc658aa9a03f5c934b7ffc6646c5ecfa41809011d0fcb9e7b60b882a1f3fa350219b399966fc6aacc85293882c3e7ed1032bd244c551ca07ae03111ee0fa22c8c3db8f0694528b52f9a55f45cc83073fe6c3a794d68c4e51cb878fad0aaaa91b5c938faa93b7ee4b3e740e6f6fd0e1f8f16d66a0e2573f1350219bbd83f4f98951eea5a85b9938442977d5ca4e7e37b88655cf8a524170e244935fbdcc5b877ecc874fa9e8a1944e5b0f015ca9d529855e3f6351f1dacd39d4fceaaae052d4d55cf32bb30a36c8d0aa5654b81e3fdec49c51732e596153e6adc3a1b57ee9d71ea7d6926aa322c1d503a8de4b56d8774842369754bb0611864a7e83085541f84726ae1628385c393b49014f6e84fe54c866a78bbeaea6ac3c7ae6adc3ca53bc64352a205cbd819a675e1586d6ba7054da88926d9ba1156ccfde7d5a33e6bf973fb47a9575ed0581ab37503b3a1c927c53761faa90cd65dd0fb2c253f7e699d11e2acc1a25a24e60b83efb6ca3eb6652feb9543165dc1d09d2b7b4660cf8e82f8890c38d4930b8ba02f5d4a91dc3cdd651df68819c16080057fe39ea8913cd39c58dc5a30586b305f2c2d5eafa7674c4ab6ac3b98345dd435ac01fae66a09e3cd91252ccc82b5a205ac02fe90605d4cece3891c63e152d50400bb8cdae9d9d9bb358c523f2020a58c2ac11970ca19ba83c65252cb883688614b5549e6207ee4149115986197e3568b54565c685abb2f10bdc1655ccd2ab0ccf7df08a00e97d030619d9dcb065e9d29b02f60eb9de38ce092203f26b29011383b0e533c131329fb86429ed70951158821f9096ac51ac8221eca05f8e70648ec93297018d3039f05fba68af2bb477745a8537132812e6816b3a5013c2e41b128539c9acb56196433a141e1282e451c449bc82125be00a881e3dda505009ca9139f25c29cd8fffc50d5be4f6c5ac8b50d178a62712c90aed449845f457f1d45b7c89444ff812d7e545a63611c517097bace102816af047346dc94a045246a41bcc6032c8036e778139c2fc0b86c8ce28b3ce22c6524b262422062044874482b6749808b0c5f7005bfa4b91e95c6881f82fd002b18511eb183162c497d01df4485a8b1090f85f91ee19fa227f9fd2dc088d8fe288632aae79cb5f716314b6c28547592fc8f08116883a0032d4885a66d70e449914a5f0abcc910961e0a7c86ba7a8051f593b7ca24199978040a471a8abdb848a50dde429556931f025e2cecafc912dad3bbe5676d4684e9e8ee07ddb02d7e0f5550c43f412b4ab1ce9d3dd57fa5d92006ddcd979f4abafbe6a6a6a9e5a552d8c80bea2649ae0cc0048a986ce7de3c68d77de79577665147ceee449f0afaf6f90d3bec20d214bc5d20ed372366e0b0a026cfffdf4d3244990ac518c2048c385fcd1608b3ff44e9941070f9e10185168815a4e9e3cf5f9e79f239fba802b1273544d1bc040fa8f520d46686b3b824a7b7a7a2195981271770a8f81bef8e28bb367bbd23a2a0c955d0359058497181645204f3aac1428fff1e259c88ce58c802b0632e9d7a0b1f60f4690c4b0ab446346c1e74f9f4641c4888e702d332c8b4ca1b2d78a7fac59bb0e736cfa4b444845a7bc7efd3a3a253a87cc329c8513e2005b4d8052e84f608899b061cb4080484ccb00cf975f7e09fe488b2873ba8a08f7e9b95ad488dc05c0a152111802cfe0803fcc42221106dc01f9259402744529e49e1451f031db8027ba354492532bbe5102a6c22b366c59755fbc884afbfbfbc147046a17ae0a3ec81605308b4a9521464e745291b43de13ea453a2a47f12a99ca12f649690c3bc2a5f6b65db54542142288b821834ad2d5508821185603a7c78a2fdc4842073a5a0d7caf0fca2e1316cc34d458fc4dc856fe48a4e812b7c3f013ff35f769a82ab06c70ffc3ff9e493ecafe96ff06ff890daa0ad0393e4a9e7c1e4fa8d1be8eb8d8d4d10035df3f4e933f8b2b77760ea93ae265cf1d6d69d20c07fe13d2a02676540a230e9876789fbfafa50c5cb2fbf42e1444045bb5305b3235d98e0a9a4ab110b01f1d34d706ddc961d16152ba10862882b0c91dc557a46b6562ad4ef11ae3e9685bb05e70a38115d1f3b19721f45363cda5b84e14586327c090c8b6c71c27f462753bc297447e56d9a36d71392b588590e8e9c105d4c71f00c450074f1251678f81e672d69708ad4efdac4e458c8410078d4f01ba5186272c6f882493b9d8736cd1334f0f051a3043322d70962b1c8c41f722048e7396d6e5806a3c0b163cfc22380b3209706f8b748de2373c682279c085916356268c34029f585332f1d6091d103e3a69ce441b6b5719b2c3ed01c83c34d9a40fe9a76bfe10a61f70e1170c4af2808d08ae6f3e937b9cb8cc8cd613832803788ce0d3c08e5918d526ec9ca93187871a269f187cea16cf9a2a364130d62124e9365a729c10d0e2ab66dd2c9945091a857ba8e90071369365f2bc51365a10ed80aec893f0c49625452e2092b4cd09b95f3278c4d18bfd2ce0284c188a0f4154cb9181d802e78da4a4e13001510c59b5b51249bd80635a2152443ec1ec926c02a40a90bc3019c97f442140bec74aa7b39f9635350ae26c01ca3955cda88bae02928d93115a50afabf230aca3d32cf6381e0afd5b05f9a5db5ba4a88fd5eb9fc762dabd0a7578c39590d93e211ae25dad069df2fbf88f08ab16d032f200f2b9cfd605e95a71a795889b286a93e3ff38ae410e15a91cd1a95aa4c0b44b85666bb46ad2ad20211ae15d9ac51a9cab440846b65b66bd4aa222d10e15a91cd1a95aa4c0bfc0fcec7ad94945e312e0000000049454e44ae426082'))
        i.close()
    img.set_image(imgfile)
  """
)


f = open(builded_file, 'w')
f.write(builded)

